---
title: Meltdown攻击
date: 2024-3-3 17:13
category:
- security
---

今天和群友聊天的时候知道了[*Meltdown attack/spectre*](https://meltdownattack.com/)这种奇妙的侧信道攻击手法。
利用这种手法，任意的进程都可以得到物理内存中的任意内容，可以轻易地得到内核中的敏感信息。

## 什么是侧信道攻击

什么是侧信道攻击？
侧信道是指你的程序在正常的通信渠道以外，产生了某些其他的特征，而攻击者从这些特
里拿到了你不想暴露的信息。这个“其他的特征”产生的信息通道就是侧信道。举个例子，假设你正在破解一个保险箱的密码，从正常的通信渠道来说你只能暴力破解，逐个尝试，但是当你破解第一位密码时，你发现旋钮到了4会有一些微弱的不一样的响声，那么可以有理由猜测第一位密码是4，这个例子里“旋钮是否发出异响”就是一个侧信道，通过它攻击者得到了保险箱的密码。

## Meltdown的攻击原理
CPU运行的时候，不可避免的，总是要从内存中取数据的，而内存相对与CPU很慢，为了避免取数据时CPU空等，CPU工程师就发明了指令预取技术。假设有一个程序长下面这样：
```
if (MEM == 0):
	instructionA;
```
`MEM == 0`不一定成立，若`MEM == 0`不成立，站在软件的层面来想，`instructionA`不应该被执行，但是由于指令指令预取技术的存在，CPU会“抢跑”，提前将`instructionA`执行了，如果`MEM == 0`成立，那就可以直接继续执行`instructionA`之后的指令；不成立的话CPU需要回滚把`instructionA`造成的影响撤销。

另外，由于cache的存在，以及缓存局部性的问题，在同一时刻不同内存地址的访问速度并不均匀，也就是latency并不相同。`meltdown`就是利用了latency这一信息来获取敏感信息的，非常得具有想象力。例如我想攻击某一个对象，要得到其中某个地址`ptr`中的内容，我只需要设法和攻击对象共享一个数组`A`，然后诱导攻击对象利用`ptr`的内容`data`作为下标访问这个数组，那么由于之前访问过`A[data]`了，再次访问到`A[data]`的时候latency会更低。

根据上面的原理，我们可以构造以下的攻击内核的`meltdown`程序：
```cpp
raise_exception();
access A[*ptr]; // ptr就是我对攻击对象感兴趣的地址, A则是我这个进程里的一个内容
```
按理来说，`ptr`对于攻击程序的进程来说可能是一个非法的地址，操作系统会阻止它访问，并且前面有`raise_exception`这个函数会引发一个异常，按理来说更不应该执行到下面这个语句。但是，由于预取的存在，CPU提前读了`ptr`里的内容，那么我再次逐个访问`A`里的元素，发现有某一个元素的访问延迟特别低，于是乎我们就知道`ptr`里的内容是多少了。想要知道某个地址对应的字节是什么，`A`只需是一个长度为256的数组即可。多么可怕又有想象力的攻击手段。要利用这个特性，需要CPU在预测失败的时候不仅将寄存器回滚，还需要将Cache也回滚

## Reference
1. [15分钟读懂英特尔熔断幽灵漏洞](https://www.bilibili.com/video/BV1vW411374T)
2. [给程序员解释Spectre和Meltdown漏洞](https://zhuanlan.zhihu.com/p/32784852)

